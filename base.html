<!--suppress CssUnknownTarget -->
<html>

<script id="email-view" type="text/html">
    <div id="email">
        <input placeholder="Enter your email" value="{{form.email}}">
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="calibration-view" type="text/html">
    <div id="calibrations">
        {{#each calibrations :num}}
        <div id="calibration-{{num}}">
            <span>{{question}}</span>
            <div id="answer-options-{{num}}">
                {{# answerOptions : i}}
                <label><input type="radio" id="answer-options-{{num}}-{{i}}" name=" {{num}}" value={{id}}>{{option}}</label>
                {{/}}
            </div>
        </div>
        {{/each}}
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="experiment-header" type="text/html">
    <h4>{{title}}</h4>
    <span>{{description}}</span>
</script>

<script id="answer-view" type="text/html">
    <!-- TODO max answers to give -->
    {{>experiment-header}}
    <div id="answer-constraints">
        {{#each constraints}}
        <ul>
            <li>{{name}}</li>
        </ul>
        {{/each}}
    </div>
    <div>
        <textarea name="answer" value="{{content}}" placeholder="Enter your answer here!"></textarea>
    </div>
    {{#if answerType === "images"}}
    <div class="image-container">
        {{#each pictures}}
        <div class="image"
             style="background-image: url({{url}});">
        </div>
        {{/each}}
    </div>
    {{/if}}
    <button on-click="submit">Submit</button>
    <button on-click="skip">Skip</button>
</script>

<script id="rating-view" type="text/html">
    {{>experiment-header}}
    <div id="answers">
        {{#each answers :num}}
        <div id="answer{{num}}">
            <textarea name="feedback" placeholder="Write a feedback! (optional)"></textarea>
            <div id="rating-options">
            </div>
            <div id="rating-constraints">
                {{#each constraints}}
                <label>
                    <input type='checkbox' name='{{name}}' value='{{id}}'>{{name}}
                </label>
                {{/each}}
            </div>
        </div>
        {{/each}}
    </div>
</script>

<script id="finished-view" type="text/html">
    <span>You have finished all tasks. Thank you for participating!</span>
    <button on-click="next">Next!</button>
</script>
<!--
     1. This is the element we'll render our Ractive to.
-->
<div id='container'></div>

<!--
     2. You can load a template in many ways. For convenience, we'll include it in
     a script tag so that we don't need to mess around with AJAX or multiline strings.
     Note that we've set the type attribute to 'text/ractive' - though it can be
     just about anything except 'text/javascript'
-->


<!--
     3. You can always get the most recent stable version from the URL below.
     If you want the newest features (unstable!), use the 'edge' version instead:

         http://cdn.ractivejs.org/edge/ractive.min.js

     If you need IE8 support, change 'ractive' to 'ractive-legacy'.
-->
<script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>
<script src="http://code.jquery.com/jquery-2.0.0.js"></script>

<!--
     4. We've got an element in the DOM, we've created a template, and we've
     loaded the library - now it's time to build our Hello World app.
-->
<script>
    var DefaultView = Ractive.extend({
        el: "#container",

        logForm: function(form) {
            console.log(JSON.stringify(this.get("form")));
        }
    });

    var EmailView = DefaultView.extend({
        template: "#email-view",

        oninit: function () {
            this.on("submit", function () {
                this.fire("next");
                this.logForm();
            });
        }
    });

    var CalibrationView = DefaultView.extend({
        template: "#calibration-view",

        oninit: function () {
            this.on("submit", function () {
                this.fire("next");
                this.getCalibrations()
                this.logForm();
            });
        },

        getCalibrations: function () {
            this.findAll('input[type="radio"]').map()
        }
    });

    var AnswerView = DefaultView.extend({
        // The `el` option can be a node, an ID, or a CSS selector.
        template: "#answer-view",

        oninit: function () {
            this.on({
                submit: function () {
                    alert("Submitting!");
                    this.logForm();
                },

                skip: function () {
                    this.fire("next");
                }
            });
        }
    });

    var RatingView = DefaultView.extend({
        el: '#container',
        template: "#answer-view",

        oninit: function () {
            this.on({
                submit: function () {
                    alert("Submitting!");
                    this.logForm();

                },

                skip: function () {
                    this.fire("next");
                }
            });
        }
    });

    var FinishedView = DefaultView.extend({
        template: "#finished-view"
    });


    var Promise = Ractive.Promise;

    /*    ractive.set('name', "Simon");
     var ajax = $.ajax();



     $.ajax("creative_task.json").done(function (jsonTask) {

     });

     ractive.on('submit', function () {
     Promise.all([
     ractive.set('loading', true),
     $.getJSON('creative_task.json')
     ]).then(function (results) {
     var ajaxData = results[0];
     ractive.set({
     loading: false,
     list: ajaxData
     });
     });
     });*/

    CreativeCrowd = (function () {
        var hooks = {};
        var properties;

        var types = loop(["email", "calibration", "answer", "rating", "finished"]);

        function loop(array) {
            var index = 0;
            return {
                next: function () {
                    return array[index++ % array.length]
                }
            }
        }


        function queryNext() {
            // for testing
            $.getJSON(properties.workerServiceURL + "/" + types.next() + ".json", function (data, status) {
                if (status === "success") {
                    viewNext(data);
                } else {
                    console.log(status);
                }
            })
        }

        var ractive, currentViewType;

        function viewNext(next) {
            if (next["type"] === currentViewType) {
                ractive.set(next);
            } else {
                ractive.teardown();
                switch (next["type"]) {
                    case "EMAIL":
                        ractive = new EmailView({
                            data: next
                        });
                        break;
                    case "CALIBRATION":
                        ractive = new CalibrationView({
                            data: next
                        });
                        break;
                    case "ANSWER":
                        ractive = new AnswerView({
                            data: next
                        });
                        break;
                    case "RATING":
                        ractive = new RatingView({
                            data: next
                        });
                        break;
                    case "FINISHED":
                        ractive = new FinishedView({
                            data: next
                        });
                        break;
                    default:
                        console.log("Unknown type: " + next["type"])
                }

                currentViewType = next["type"];

                ractive.on("next", function () {
                    queryNext();
                });
            }

        }

        return {
            init: function (props) {
                properties = props;
                this.currentViewType = "DEFAULT";
                ractive = new DefaultView();
            },

            onSubmitEmail: function (call) {
                hooks.email = call;
            },

            onSubmitCalibration: function (call) {
                hooks.calibration = call
            },

            onSubmitAnswer: function (call) {
                hooks.answer = call;
            },

            onSubmitRating: function (call) {
                hooks.rating = call;
            },

            onFinished: function (call) {
                hooks.finished = call;
            },

            //starts loading the first "next view"
            load: function () {
                queryNext();
            }
        }
    })();


    CreativeCrowd.init(properties = {
        workerServiceURL: "/WorkerUI/test",
        platform: "mturk",
        params: {
            workerId: 5,
            assignmentId: 1234
        },
        preview: false
    });

    CreativeCrowd.load();
    CreativeCrowd.onSubmitAnswer(function (data) {
        console.log("answer submitted" + JSON.stringify(data))
    });
    CreativeCrowd.onSubmitCalibration(function (data) {
        console.log("calibration submitted" + JSON.stringify(data))
    });
</script>
</html>
