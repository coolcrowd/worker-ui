<!--suppress ALL -->

<html>

<script id="email-view" type="text/html">
    <div id="email">
        <input placeholder="Enter your email" value="{{form.email}}">
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="calibration-view" type="text/html">
    <div id="calibrations">
        {{#each calibrations :i}}
        <div id="calibration-{{i}}">
            <span>{{question}}</span>
            <div>
                {{# answerOptions : j}}
                <label>
                    <input on-change="radioChange" type="radio" name="{{value}}-{{i}}" id="{{i}}-{{j}}" value={{id}}>
                    {{option}}
                </label>
                {{/}}
            </div>
        </div>
        {{/each}}
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="experiment-header" type="text/html">
    <h4>{{title}}</h4>
    <span>{{description}}</span>
</script>

<script id="answer-view" type="text/html">
    <!-- TODO max answers to give -->
    {{>experiment-header}}
    <div id="answer-constraints">
        <span>
            The following constraints must not be violated:
        </span>
        {{#each constraints}}
        <ul>
            <li>{{name}}</li>
        </ul>
        {{/each}}
    </div>
    <div>
        <textarea name="answer" value="{{content}}" placeholder="Enter your answer here!"></textarea>
    </div>
    {{#if answerType === "images"}}
    <div class="image-container">
        {{#each pictures}}
        <div class="image"
             style="background-image: url({{url}});">
        </div>
        {{/each}}
    </div>
    {{/if}}
    <button on-click="submit">Submit</button>
    <button on-click="skip">Skip</button>
</script>

<script id="rating-view" type="text/html">
    {{>experiment-header}}
    <div id="answers">
        {{#each answers :i}}
        <div id="answer{{i}}">
            <textarea name="feedback" placeholder="Write a feedback! (optional)"></textarea>
            <div id="rating-options">
                <span>Please rate!</span>
                {{#each ratingOptions:j}}
                <label>
                    <input on-change="radioChange" type="radio" name="{{value}}-{{i}}" id="{{i}}-{{j}}" value={{id}}>
                    {{option}}
                </label>
                {{/each}}
            </div>
            <div id="rating-constraints">
                <span>
                    The answer has the following constraints.
                    Check all that are violated and do not apply for this answer.
                </span>
                {{#each constraints:j}}
                <label>
                    <input on-change="checkboxChange" type="checkbox" name="{{value}}-{{i}}" id="{{i}}-{{j}}">
                    {{description}}
                </label>
                {{/each}}
            </div>
        </div>
        {{/each}}
    </div>
</script>

<script id="finished-view" type="text/html">
    <span>You have finished all tasks. Thank you for participating!</span>
    <button on-click="next">Next!</button>
</script>
<!--
     1. This is the element we'll render our Ractive to.
-->
<div id='container'></div>

<!--
     2. You can load a template in many ways. For convenience, we'll include it in
     a script tag so that we don't need to mess around with AJAX or multiline strings.
     Note that we've set the type attribute to 'text/ractive' - though it can be
     just about anything except 'text/javascript'
-->


<!--
     3. You can always get the most recent stable version from the URL below.
     If you want the newest features (unstable!), use the 'edge' version instead:

         http://cdn.ractivejs.org/edge/ractive.min.js

     If you need IE8 support, change 'ractive' to 'ractive-legacy'.
-->
<script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>
<script src="http://code.jquery.com/jquery-2.0.0.js"></script>

<!--
     4. We've got an element in the DOM, we've created a template, and we've
     loaded the library - now it's time to build our Hello World app.
-->
<script>
    var DefaultView = Ractive.extend({
        el: "#container",

        logForm: function (form) {
            console.log(JSON.stringify(this.get("form"), null, 4));
        },

        setEmptyForm: function () {

        }
    });

    var EmailView = DefaultView.extend({
        template: "#email-view",

        oninit: function () {
            this.on("submit", function () {
                this.logForm();
                this.fire("submitEmail", this.get());
                this.fire("next");
            });
        }
    });

    var CalibrationView = DefaultView.extend({
        template: "#calibration-view",

        oninit: function () {
            this.setEmptyForm();
            this.on({
                submit: function () {


                    this.logForm();
                    this.fire("submitCalibration", this.get());
                    this.fire("next");
                },

                radioChange: function () {
                    var radios = this.findAll('input[type="radio"]:checked').map(function (radio) {
                        return {
                            answerOption: radio.value,
                            // id is something like 0-1, 0-2, 0-3,
                            // where the first number is the calibrationId and the second the answerOptions.index
                            calibrationId: radio.id.charAt(0)
                        };
                    });
                    this.set("form", radios);
                }


            });
        }
    });

    var AnswerView = DefaultView.extend({
        template: "#answer-view",

        oninit: function () {
            this.on({
                submit: function () {
                    this.logForm();
                    //TODO actual submitting
                    this.fire("submitAnswer", this.get())
                    this.fire("next");

                },

                skip: function () {
                    this.fire("next");
                }
            });
        }
    });

    var RatingView = DefaultView.extend({
        template: "#rating-view",

        oninit: function () {
            this.on({
                submit: function () {
                    this.logForm();
                    this.fire("submitRating", this.get());
                    this.fire("next");
                },

                skip: function () {
                    this.fire("next");
                },

                checkboxChange: function () {
                    var checks = this.findAll('input[type="checkbox"]:checked').map(function (check) {
                        return {
                            // id is something like 0-1, 0-2, 0-3,
                            // where the first number is the calibrationId and the second the answerOptions.index
                            ratingId: checks.id.charAt(0)
                        };
                    });
                    this.set("form.constraint", checks);
                }
            });
        }
    });

    var FinishedView = DefaultView.extend({
        template: "#finished-view",

        oninit: function () {
            this.on("next", function () {
                this.fire("submitFinished")
            })
        }
    });


    var Promise = Ractive.Promise;

    /*    ractive.set('name', "Simon");
     var ajax = $.ajax();



     $.ajax("creative_task.json").done(function (jsonTask) {

     });

     ractive.on('submit', function () {
     Promise.all([
     ractive.set('loading', true),
     $.getJSON('creative_task.json')
     ]).then(function (results) {
     var ajaxData = results[0];
     ractive.set({
     loading: false,
     list: ajaxData
     });
     });
     });*/

    CreativeCrowd = (function () {
        var properties;

        var types = loop(["email", "calibration", "answer", "rating", "finished"]);

        function loop(array) {
            var index = 0;
            return {
                next: function () {
                    return array[index++ % array.length]
                }
            }
        }


        function queryNext() {

            // for testing
            if (properties.workerServiceURL === undefined) {
                $.getJSON("/WorkerUI/test/" + types.next() + ".json", function (data, status) {
                    if (status === "success") {
                        viewNext(data);
                    } else {
                        console.log(status);
                    }
                })
            } else {
                var nextUrl = properties.workerServiceURL + 'next/'
                        + properties.platform + '/'
                        + properties.experiment;

                $.getJSON(nextUrl, function (data) {
                    viewNext(data);
                    alert(data);
                });

//                $.ajax({
//                    method: "GET",
//                    url: url,
//                    accepts: "application/json",
//                    // Work with the response
//                    success: function (response) {
//                        console.log(response); // server response
//                        viewNext(response)
//                    }
//                });
            }
        }

        function submit(name, data) {
            $.ajax({
                method: "POST",
                url: properties.workerServiceURL + name,
                contentType: "application/json",
                data: properties.params

            })
        }

        var ractive, currentViewType;

        function viewNext(next) {
            if (next["type"] === currentViewType) {
                ractive.set(next);
            } else {
                ractive.teardown();
                switch (next["type"]) {
                    case "EMAIL":
                        ractive = new EmailView({
                            data: next
                        });
                        break;
                    case "CALIBRATION":
                        ractive = new CalibrationView({
                            data: next
                        });
                        break;
                    case "ANSWER":
                        ractive = new AnswerView({
                            data: next
                        });
                        break;
                    case "RATING":
                        ractive = new RatingView({
                            data: next
                        });
                        break;
                    case "FINISHED":
                        ractive = new FinishedView({
                            data: next
                        });
                        break;
                    default:
                        console.log("Unknown type: " + next["type"])
                }

                currentViewType = next["type"];

                addHooks();

                ractive.on("next", function () {
                    queryNext();
                });
            }

        }

        var hooks = {};

        function addHooks() {
            // how can this be done cleaner?
            if (hooks.any !== undefined) {
                ractive.on("submit", hooks.any);
            }
            if (hooks.email !== undefined) {
                ractive.on("submitEmail", hooks.email);
            }
            if (hooks.calibration !== undefined) {
                ractive.on("submitCalibration", hooks.calibration);
            }
            if (hooks.answer !== undefined) {
                ractive.on("submitAnswer", hooks.answer);
            }
            if (hooks.rating !== undefined) {
                ractive.on("submitRating", hooks.rating);
            }
            if (hooks.finished !== undefined) {
                ractive.on("submitFinished", hooks.finished);
            }
        }

        return {
            init: function (props) {
                properties = props;
                this.currentViewType = "DEFAULT";
                ractive = new DefaultView();
            },

            onSubmitAny: function (call) {
                hooks.any = call;
            },

            onSubmitEmail: function (call) {
                hooks.email = call;
            },

            onSubmitCalibration: function (call) {
                hooks.calibration = call
            },

            onSubmitAnswer: function (call) {
                hooks.answer = call;
            },

            onSubmitRating: function (call) {
                hooks.rating = call;
            },

            onFinished: function (call) {
                hooks.finished = call;
            },

            //starts loading the first "next view"
            load: function () {
                queryNext();
            }
        }
    })();


    CreativeCrowd.init(properties = {
        //workerServiceURL: "",
        platform: "mturk",
        params: {
            workerId: 5,
            assignmentId: 1234
        },
        experiment: 8,
        preview: false
    });

    CreativeCrowd.load();
    CreativeCrowd.onSubmitAnswer(function (data) {
        console.log("answer submitted" + JSON.stringify(data));
    });
    CreativeCrowd.onSubmitCalibration(function (data) {
        console.log("calibration submitted" + JSON.stringify(data));
    });
    CreativeCrowd.onSubmitAny(function () {
        console.log("Something was submitted");
    })

</script>
</html>
