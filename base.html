<!--suppress ALL -->

<html>

<script id="email-view" type="text/html">
    <div id="email">
        <input placeholder="Enter your email" value="{{toSubmit.email}}">
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="calibration-view" type="text/html">
    <div id="calibrations">
        {{#each calibrations :i}}
        <div id="calibration-{{i}}">
            <span>{{question}}</span>
            <div>
                {{# answerOptions : j}}
                <label>
                    <input on-change="radioChange" type="radio" name="options-{{i}}" id="{{i}}-{{j}}" value={{id}}>
                    {{option}}
                </label>
                {{/}}
            </div>
        </div>
        {{/each}}
        <button on-click="submit">Submit</button>
    </div>
</script>

<script id="experiment-header" type="text/html">
    <h4>{{title}}</h4>
    <span>{{description}}</span>
</script>

<script id="answer-view" type="text/html">
    <!-- TODO max answers to give -->
    <div id="answer">
        {{>experiment-header}}
        <div id="answer-constraints">
        <span>
            The following constraints must not be violated:
        </span>
            {{#each constraints}}
            <ul>
                <li>{{name}}</li>
            </ul>
            {{/each}}
        </div>
        <div>
            <textarea name="answer" value="{{toSubmit.answer}}" placeholder="Enter your answer here!"></textarea>
        </div>
        {{#if answerType === "images"}}
        <div id="images">
            {{#each pictures}}
            <div class="image"
                 style="background-image: url({{url}});">
            </div>
            <label>{{urlLicense}}</label>
            {{/each}}
        </div>
        {{/if}}
        <button on-click="submit">Submit</button>
        <button on-click="skip">Skip</button>
    </div>
</script>

<script id="rating-view" type="text/html">
    {{>experiment-header}}
    <div id="ratings">
        {{#each answers :i}}
        <div id="rating-{{i}}">
            <textarea name="feedback" placeholder="Write a feedback! (optional)"></textarea>
            <div id="rating-options">
                <span>Please rate!</span>
                {{#each ratingOptions:j}}
                <label>
                    <input on-change="radioChange" type="radio" name="options-{{i}}" id="{{i}}-{{j}}" value={{id}}>
                    {{description}}
                </label>
                {{/each}}
            </div>
            <div id="rating-constraints">
                <span>
                    The answer has the following constraints.
                    Check all that are violated and do not apply for this answer.
                </span>
                {{#each constraints:j}}
                <label>
                    <input on-change="checkboxChange" type="checkbox" name="{{value}}-{{i}}" id="{{i}}-{{j}}">
                    {{name}}
                </label>
                {{/each}}
            </div>
        </div>
        {{/each}}
    </div>
    <button on-click="submit">Submit</button>
    <button on-click="skip">Skip</button>
</script>

<script id="finished-view" type="text/html">
    <span>You have finished all tasks. Thank you for participating!</span>
    <button on-click="next">Next!</button>
</script>
<!--
     1. This is the element we'll render our Ractive to.
-->
<div id='container'></div>

<!--
     2. You can load a template in many ways. For convenience, we'll include it in
     a script tag so that we don't need to mess around with AJAX or multiline strings.
     Note that we've set the type attribute to 'text/ractive' - though it can be
     just about anything except 'text/javascript'
-->


<!--
     3. You can always get the most recent stable version from the URL below.
     If you want the newest features (unstable!), use the 'edge' version instead:

         http://cdn.ractivejs.org/edge/ractive.min.js

     If you need IE8 support, change 'ractive' to 'ractive-legacy'.
-->
<script src='http://cdn.ractivejs.org/latest/ractive.min.js'></script>
<script src="http://code.jquery.com/jquery-2.0.0.js"></script>

<!--
     4. We've got an element in the DOM, we've created a template, and we've
     loaded the library - now it's time to build our Hello World app.
-->
<script>
    var Promise = Ractive.Promise;

    /*    ractive.set('name', "Simon");
     var ajax = $.ajax();
     $.ajax("creative_task.json").done(function (jsonTask) {
     });
     ractive.on('submit', function () {
     Promise.all([
     ractive.set('loading', true),
     $.getJSON('creative_task.json')
     ]).then(function (results) {
     var ajaxData = results[0];
     ractive.set({
     loading: false,
     list: ajaxData
     });
     });
     });*/

    CreativeCrowd = (function () {
        // -------------- Views -------------------
        var DefaultView = Ractive.extend({
            el: "#container",

            logToSubmit: function () {
                console.log(JSON.stringify(this.get("toSubmit"), null, 4));
            }
        });

        var EmailView = DefaultView.extend({
            template: "#email-view",

            oninit: function () {
                this.on({
                    submit: function () {
                        toSubmit = this.get("toSubmit");
                        Promise.all([
                            postSubmit("/emails/" + properties.platform, toSubmit),
                            // TODO loading view
                            this.set("loading", true)
                        ]).then(function (results) {
                            var postResponse = results[0];
                            if (postResponse.workerId !== undefined) {
                                workerId = postResponse.workerId;
                            }
                            ractive.set("loading", false)
                        });
                        this.fire("submitEmail", this.get(), toSubmit);
                        this.fire("next");
                    }
                });
            }
        });

        var CalibrationView = DefaultView.extend({
            template: "#calibration-view",

            oninit: function () {
                this.on({
                    submit: function () {
                        var toSubmit = this.get("toSubmit");
                        this.submit(toSubmit)
                        this.logToSubmit();
                        this.fire("submitCalibration", this.get());
                        this.fire("next");
                    },

                    radioChange: function () {
                        var radios = this.findAll('input[type="radio"]:checked').map(function (radio) {
                            return {
                                // id is something like 0-1, 0-2, 0-3,
                                // where the first number is the calibrationId and the second the answerOptions.index
                                calibrationId: radio.id.charAt(0),
                                answerOption: radio.value
                            };
                        });
                        this.set("toSubmit", radios);
                    }
                });
            },

            submit: function (toSubmit) {

                postSubmit("/calibrations/" + properties.workerId)
            }
        });

        var AnswerView = DefaultView.extend({
            template: "#answer-view",

            oninit: function () {
                this.on({
                    submit: function () {
                        toSubmit = {
                            answer: this.get("toSubmit.answer"),
                            experiment: properties.experiment
                        }
                        postSubmit("/answers/" + properties.workerId, toSubmit);

                        this.fire("submitAnswer", this.get(), toSubmit)
                        this.fire("next");
                    },

                    skip: function () {
                        this.fire("next");
                    }
                });
            },
        });

        var RatingView = DefaultView.extend({
            template: "#rating-view",

            oninit: function () {
                this.on({
                    submit: function () {
                        this.logToSubmit();
                        this.fire("submitRating", this.get());
                        this.fire("next");
                    },

                    skip: function () {
                        this.fire("next");
                    },

                    checkboxChange: function () {
                        var checks = this.findAll('input[type="checkbox"]:checked').map(function (check) {
                            return {
                                // id is something like 0-1, 0-2, 0-3,
                                // where the first number is the calibrationId and the second the answerOptions.index
                                ratingId: checks.id.charAt(0)
                            };
                        });
                        this.set("toSubmit.constraint", checks);
                    }
                });
            },

            submit: function (toSubmit) {
                parent.postSubmit("/ratings/" + properties.workerId);
            }
        });

        var FinishedView = DefaultView.extend({
            template: "#finished-view",

            oninit: function () {
                this.on("next", function () {
                    this.fire("submitFinished")
                })
            }
        });

        // -------------- Controller -------------------



    CreativeCrowd.init(properties = {
        workerServiceURL: "http://localhost:5678/",
        platform: "mturksandbox",
        params: {
            workerId: 5,
        },
        experiment: 11,
        preview: false
    });

    CreativeCrowd.load();
    CreativeCrowd.onSubmitAnswer(function (viewData, submittedData) {
        console.log("viewData: \n" + JSON.stringify(viewData, null, 4));
        console.log("submittedData: \n" + JSON.stringify(submittedData, null, 4));
    });
    CreativeCrowd.onSubmitCalibration(function (data) {
        //console.log("calibration submitted" + JSON.stringify(data));
    });
    CreativeCrowd.onSubmitAny(function () {
        //console.log("Something was submitted");
    });

</script>
</html>
