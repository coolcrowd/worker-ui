<div id="ractive-container"></div>
<script src="http://localhost:3000/bundle.js"></script>
<script>

    function doIdTask(idTasks) {
        var idTask = idTasks[0];
        var authHash = CreativeCrowd.generateAuthHash();
        var identifyParams;
        var success = false;

        return $.Deferred(trySaveTask).promise();
        function trySaveTask(deferred) {
            pybossa.saveTask(idTask, {code: authHash.base64UrlHash})
                    .done(function (taskRun) {
                        identifyParams = {
                            workerId: taskRun.user_id,
                            idTask: idTask,
                            code: authHash.random
                        };
                        deferred.resolve(identifyParams);
                    }).fail(function () {
                idTask += 1;
                if (!success && idTask <= idTasks[idTasks.length - 1]) {
                    trySaveTask(deferred);
                } else {
                    deferred.reject();
                }
            });
        }
    }

    pybossa.taskLoaded(function (task, deferred) {
        if (!$.isEmptyObject(task)) {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function (task, deferred) {
        if (!$.isEmptyObject(task)) {
            if (task.info.type === "experiment") {
                CreativeCrowd.init(properties = {
                    workerServiceURL: task.info.url,
                    platform: task.info.platform,
                    experiment: task.info.expID,
                    preview: false,
                    test: false
                });

                CreativeCrowd.onFinished(function (viewData, submittedData) {
                    pybossa.saveTask(task.id, answer).done(function () {
                        deferred.resolve(task);
                    });
                });


                CreativeCrowd.beforeIdentifyWorker(function () {
                    return doIdTask(task.info.idTasks);
                });

                CreativeCrowd.load();
            }
        }
        else {
//            $(".skeleton").hide();
//            $("#loading").hide();
//            $("#finish").fadeIn(500);
        }
    });

    pybossa.run('ccw');


</script>