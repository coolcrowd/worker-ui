<div id="payment">
    <p></p>
</div>

<div id="ractive-container"></div>
<div id="id-task" class="max-width no-display">
    <div class="content">
        <h1>Sorry!</h1>
        <p class="info">
            Currently, there are no tasks for you to do.
            Feel free to come by from time to time and check for updates!
        </p>
    </div>
</div>

<script id="worker_ui" src="/worker_ui.js"></script>
<script>
    function doIdTask(idTasks) {
        var idTask = idTasks[0];
        var authHash = WorkerUI.generateAuthHash();
        var identifyParams;
        var success = false;

        return $.Deferred(trySaveTask).promise();
        function trySaveTask(deferred) {
            pybossa.saveTask(idTask, {code: authHash.base64UrlHash})
                    .done(function (taskRun) {
                        identifyParams = {
                            workerId: taskRun.user_id,
                            idTask: idTask,
                            code: authHash.random
                        };
                        deferred.resolve(identifyParams);
                    }).fail(function () {
                idTask += 1;
                if (!success && idTask <= idTasks[idTasks.length - 1]) {
                    trySaveTask(deferred);
                } else {
                    deferred.reject();
                }
            });
        }
    }

    pybossa.taskLoaded(function (task, deferred) {
        if (!$.isEmptyObject(task)) {
            deferred.resolve(task);
        }
    });

    pybossa.presentTask(function (task, deferred) {
        if (!$.isEmptyObject(task) && (task.info.type === "experiment")) {
            $("#payment").children("p").text(
                    "Base Payment: 0." + task.info.paymentBase + " USD"
            );

            WorkerUI.init(properties = {
                workerServiceURL: task.info.url,
                platform: task.info.platform,
                experiment: task.info.expID,
                preview: false,
                test: false
            });

            WorkerUI.onFinished(function (viewData, submittedData) {
                pybossa.saveTask(task.id, viewData).done(function () {
                    deferred.resolve(task);
                });
            });

            WorkerUI.beforeIdentifyWorker(function () {
                return doIdTask(task.info.idTasks);
            });

            WorkerUI.load();
        } else {
            $("#payment").hide();
            $("#id-task").show();
        }
    });

    pybossa.run('ccw');


</script>