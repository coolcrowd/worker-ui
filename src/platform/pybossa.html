<div id="ractive-container"></div>
<script src="http://localhost:3000/bundle.js"></script>
<script>
    pybossa.taskLoaded(function (task, deferred) {
        if (!$.isEmptyObject(task)) {
            var returnTask = sessionStorage.returnTask;
            if (task.info.type === "idTask" && sessionStorage.returnTask !== undefined) {
                var code = generateCode();
                pybossa.saveTask(task.id, code).done(function (taskRun) {
                    sessionStorage.identifyParams = {
                        workerId: taskRun.user_id,
                        idTask: task.id,
                        code: code};
                    deferred.resolve(task);
                    // return to prev task
                    window.location.replace("http://localhost:5000/project/ccw/task/" + returnTask);
                });
            }

            CreativeCrowd.init(properties = {
                workerServiceURL: "http://localhost:8080/",
                platform: task.info.platform,
                experiment: task.info.expID,
                preview: false,
                test: false
            });

            CreativeCrowd.onFinished(function (viewData, submittedData) {
                pybossa.saveTask(task.id, answer).done(function () {
                    deferred.resolve();
                });
            });


            CreativeCrowd.beforeIdentifyWorker(function () {
                // 1 the first time this gets called identity param should be empty.
                if (sessionStorage.identifyParams) {
                    var identifyParams = sessionStorage.identifyParams;
                    sessionStorage.removeItem("identifyParams");
                    // 2 the second time this is called, we have our params and can return them.
                    return identifyParams;
                }
                // 1 so we redirect to an idtask
                localStorage.setItem("returnTask", task.id);
                window.location.replace("http://localhost:5000/project/ccw/task/" + task.info.idTasks[0]);
            });


        }
        deferred.resolve(task);
    });

    pybossa.presentTask(function (task, deferred) {
        if (!$.isEmptyObject(task)) {
            CreativeCrowd.load();
        }
        else {
//            $(".skeleton").hide();
//            $("#loading").hide();
//            $("#finish").fadeIn(500);
        }
    });

    // this generates a random code with 10 characters in [a-zA-Z0-9]
    function generateCode() {
        var s = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        return Array.apply(null, new Array(10)).map(function () {
            return s.charAt(Math.floor(Math.random() * s.length));
        }).join('');
    }

    pybossa.run('ccw');


</script>